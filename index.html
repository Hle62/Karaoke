<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Ultimate AI Karaoke Pro</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://unpkg.com/pitchfinder@2.3.0/dist/pitchfinder.amd.js"></script>
    <script src="https://unpkg.com/kuroshiro@1.2.0/dist/kuroshiro.min.js"></script>
    <script src="https://unpkg.com/kuroshiro-analyzer-kuromoji@1.1.0/dist/kuroshiro-analyzer-kuromoji.min.js"></script>
    <style>
        :root { --bg: #050505; --accent: #00f2ff; --panel: #1a1a1c; --text: #e0e0e0; }
        body { font-family: 'Segoe UI', Meiryo, sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow: hidden; }
        
        .header { background: var(--panel); padding: 15px; display: flex; justify-content: center; gap: 10px; border-bottom: 2px solid #333; }
        input[type="text"] { width: 350px; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #222; color: white; }
        .btn { background: var(--accent); color: black; font-weight: bold; border: none; padding: 10px 25px; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .btn:hover { opacity: 0.8; }

        .main-container { display: grid; grid-template-columns: 350px 1fr; gap: 15px; padding: 15px; height: calc(100vh - 85px); }
        #search-results { background: var(--panel); border-radius: 12px; overflow-y: auto; padding: 10px; border: 1px solid #333; }
        .video-card { display: flex; gap: 10px; margin-bottom: 12px; cursor: pointer; padding: 8px; border-radius: 8px; background: #222; border: 1px solid transparent; }
        .video-card:hover { border-color: var(--accent); }
        .video-card img { width: 100px; border-radius: 6px; pointer-events: none; }

        .display-side { display: flex; flex-direction: column; gap: 15px; overflow: hidden; }
        #player { width: 100%; height: 260px; background: #000; border-radius: 12px; }
        
        .lyrics-box { flex-grow: 1; background: #000; border-radius: 12px; border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        #lyrics-content { flex-grow: 1; padding: 150px 40px; overflow-y: auto; text-align: center; scroll-behavior: smooth; }
        
        /* 歌詞のスタイル */
        .lyric-line { font-size: 32px; font-weight: bold; margin: 40px 0; opacity: 0.2; transition: all 0.4s; }
        .lyric-line.active { opacity: 1; color: var(--accent); transform: scale(1.1); text-shadow: 0 0 15px rgba(0,242,255,0.5); }
        .lyric-line.no-sync { opacity: 1; transform: none; color: white; }
        ruby { ruby-position: over; }
        rt { font-size: 14px; color: #00f2ff; font-weight: normal; }

        /* 設定パネル */
        #settings-panel { position: fixed; right: 20px; bottom: 80px; width: 300px; background: var(--panel); border: 1px solid #444; border-radius: 15px; padding: 20px; display: none; z-index: 2000; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        .setting-item { margin-bottom: 20px; }
        .setting-item label { display: flex; justify-content: space-between; font-size: 13px; color: #aaa; margin-bottom: 8px; }
        .setting-item input[type="range"] { width: 100%; cursor: pointer; }
        .toggle-box { display: flex; align-items: center; justify-content: space-between; cursor: pointer; padding: 5px 0; }
        
        .settings-toggle { position: fixed; right: 20px; bottom: 20px; width: 50px; height: 50px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 24px; z-index: 2001; }

        #boot-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; }
    </style>
</head>
<body>

<div id="boot-screen" onclick="startApp()">
    <button class="btn" style="font-size: 28px; padding: 25px 80px; border-radius: 50px;">KARAOKE START</button>
</div>

<div class="header">
    <input type="text" id="search-q" placeholder="曲名・歌手名を検索...">
    <button class="btn" onclick="search()">動画検索</button>
</div>

<div class="main-container">
    <div id="search-results">曲を検索してください</div>
    <div class="display-side">
        <div id="player"></div>
        <div class="lyrics-box">
            <div id="lyrics-content"></div>
        </div>
    </div>
</div>

<div class="settings-toggle" onclick="toggleSettings()">⚙️</div>
<div id="settings-panel">
    <h3 style="margin: 0 0 20px 0; font-size: 18px; border-bottom: 1px solid #333; padding-bottom: 10px;">カラオケ設定</h3>
    
    <div class="setting-item">
        <div class="toggle-box" onclick="toggleSwitch('isFuriganaEnabled')">
            <span>デフォルトでルビを表示</span>
            <input type="checkbox" id="check-furigana" checked>
        </div>
        <div class="toggle-box" onclick="toggleSwitch('isSyncEnabled')">
            <span>歌詞の自動同期</span>
            <input type="checkbox" id="check-sync" checked>
        </div>
    </div>

    <div class="setting-item">
        <label>マイク音量 <span id="val-mic">1.0</span></label>
        <input type="range" min="0" max="2" step="0.1" value="1.0" oninput="updateAudio('mic', this.value)">
    </div>
    <div class="setting-item">
        <label>エコーの強さ <span id="val-fb">0.3</span></label>
        <input type="range" min="0" max="0.8" step="0.05" value="0.3" oninput="updateAudio('fb', this.value)">
    </div>
    <div class="setting-item">
        <label>エコーの音量 <span id="val-echo">0.4</span></label>
        <input type="range" min="0" max="1" step="0.1" value="0.4" oninput="updateAudio('echo', this.value)">
    </div>
    
    <button class="btn" style="width: 100%;" onclick="toggleSettings()">完了</button>
</div>

<script>
    const API_KEY = 'AIzaSyB_tQGyb86O2w0_5Y0LpGpRS6OkIxkF_ro';
    let player, audioCtx, kuroshiro;
    let micGain, delayNode, feedbackGain, echoGain;
    let syncedLyrics = [];
    let isFuriganaEnabled = true;
    let isSyncEnabled = true;

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            videoId: 'LpI2vjX9mDM',
            playerVars: { 'modestbranding': 1, 'origin': window.location.origin, 'enablejsapi': 1 }
        });
    }

    async function search() {
        const q = document.getElementById('search-q').value;
        if (!q) return;
        const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(q + " カラオケ")}&type=video&maxResults=12&key=${API_KEY}`;
        try {
            const res = await fetch(url);
            const data = await res.json();
            const list = document.getElementById('search-results');
            list.innerHTML = "";
            data.items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'video-card';
                card.onclick = () => { player.loadVideoById(item.id.videoId); fetchLyrics(item.snippet.title); };
                card.innerHTML = `<img src="${item.snippet.thumbnails.medium.url}"><div style="font-size:12px;">${item.snippet.title}</div>`;
                list.appendChild(card);
            });
        } catch (e) { alert("検索エラー"); }
    }

    async function fetchLyrics(title) {
        const content = document.getElementById('lyrics-content');
        content.innerHTML = "歌詞を読み込み中...";
        syncedLyrics = [];
        let cleanTitle = title.replace(/【.*?】|\[.*?\]|カラオケ|off vocal|歌ってみた|MV|Official|/gi, "").trim();
        
        try {
            const res = await fetch(`https://lrclib.net/api/search?q=${encodeURIComponent(cleanTitle)}`);
            const data = await res.json();
            if (data && data.length > 0) {
                const match = data[0];
                if (match.syncedLyrics) parseLRC(match.syncedLyrics);
                else content.innerHTML = `<div class="lyric-line no-sync">${match.plainLyrics.replace(/\n/g,"<br>")}</div>`;
                renderLyrics();
                if (isFuriganaEnabled) setTimeout(convertFurigana, 500);
            } else { content.innerHTML = "歌詞が見つかりませんでした。"; }
        } catch (e) { content.innerHTML = "歌詞取得エラー"; }
    }

    function parseLRC(lrc) {
        const lines = lrc.split('\n');
        const timeReg = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/;
        lines.forEach(line => {
            const m = timeReg.exec(line);
            if (m) {
                const sec = parseInt(m[1])*60 + parseInt(m[2]) + parseInt(m[3])/100;
                syncedLyrics.push({ time: sec, text: line.replace(timeReg, "").trim() });
            }
        });
    }

    function renderLyrics() {
        const content = document.getElementById('lyrics-content');
        content.innerHTML = "";
        if (syncedLyrics.length === 0) return;
        syncedLyrics.forEach((l, i) => {
            const d = document.createElement('div');
            d.className = 'lyric-line'; d.id = 'line-' + i; d.innerText = l.text;
            content.appendChild(d);
        });
    }

    async function convertFurigana() {
        if (!kuroshiro) return;
        const lines = document.querySelectorAll('.lyric-line');
        for (let l of lines) {
            const ruby = await kuroshiro.convert(l.innerText, { to: "hiragana", mode: "furigana" });
            l.innerHTML = ruby;
        }
    }

    async function startApp() {
        document.getElementById('boot-screen').style.display = 'none';
        
        // フリガナエンジン初期化
        kuroshiro = new Kuroshiro();
        const analyzer = new KuromojiAnalyzer({ dictPath: "https://unpkg.com/kuroshiro-analyzer-kuromoji@1.1.0/dict" });
        await kuroshiro.init(analyzer);

        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const source = audioCtx.createMediaStreamSource(stream);

        // --- オーディオ回路の再構築 ---
        micGain = audioCtx.createGain(); // 全体の音量調整用
        micGain.gain.value = 1.0;

        // モニター用（自分の声）
        const monitorGain = audioCtx.createGain();
        monitorGain.gain.value = 1.0;

        // エコー用
        delayNode = audioCtx.createDelay();
        delayNode.delayTime.value = 0.25;
        feedbackGain = audioCtx.createGain();
        feedbackGain.gain.value = 0.3;
        echoGain = audioCtx.createGain();
        echoGain.gain.value = 0.4;

        // 接続
        source.connect(micGain);
        
        // 生音をスピーカーへ
        micGain.connect(monitorGain);
        monitorGain.connect(audioCtx.destination);

        // エコー回路
        micGain.connect(delayNode);
        delayNode.connect(feedbackGain);
        feedbackGain.connect(delayNode);
        delayNode.connect(echoGain);
        echoGain.connect(audioCtx.destination);

        if(player && player.playVideo) player.playVideo();
        loop();
    }

    function updateAudio(type, val) {
        document.getElementById('val-' + type).innerText = val;
        if (!audioCtx) return;
        if (type === 'mic') micGain.gain.setTargetAtTime(val, audioCtx.currentTime, 0.05);
        if (type === 'fb') feedbackGain.gain.setTargetAtTime(val, audioCtx.currentTime, 0.05);
        if (type === 'echo') echoGain.gain.setTargetAtTime(val, audioCtx.currentTime, 0.05);
    }

    function toggleSwitch(key) {
        if (key === 'isFuriganaEnabled') {
            isFuriganaEnabled = !isFuriganaEnabled;
            document.getElementById('check-furigana').checked = isFuriganaEnabled;
            if (isFuriganaEnabled) convertFurigana(); else renderLyrics(); // OFF時はルビなしで再描画
        }
        if (key === 'isSyncEnabled') {
            isSyncEnabled = !isSyncEnabled;
            document.getElementById('check-sync').checked = isSyncEnabled;
            if (!isSyncEnabled) {
                // 同期OFF時は全行を表示状態にする
                document.querySelectorAll('.lyric-line').forEach(l => l.classList.add('no-sync'));
            } else {
                document.querySelectorAll('.lyric-line').forEach(l => l.classList.remove('no-sync'));
            }
        }
    }

    function loop() {
        if (player && player.getPlayerState() === 1 && isSyncEnabled) {
            const time = player.getCurrentTime();
            let active = 0;
            for (let i=0; i<syncedLyrics.length; i++) {
                if (time >= syncedLyrics[i].time) active = i; else break;
            }
            const lines = document.querySelectorAll('.lyric-line');
            lines.forEach((l, i) => {
                if (i === active) {
                    if (!l.classList.contains('active')) {
                        l.classList.add('active');
                        l.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                } else l.classList.remove('active');
            });
        }
        requestAnimationFrame(loop);
    }

    function toggleSettings() {
        const p = document.getElementById('settings-panel');
        p.style.display = p.style.display === 'block' ? 'none' : 'block';
    }
</script>
</body>
</html>