<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>AI Karaoke - Ultra Lyrics Finder</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        :root { --bg: #050505; --accent: #00f2ff; --panel: #16161a; --text: #e0e0e0; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow: hidden; }
        
        /* ヘッダー */
        .header { background: var(--panel); padding: 15px; display: flex; justify-content: center; gap: 10px; border-bottom: 2px solid #333; }
        input { width: 350px; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #222; color: white; font-size: 16px; }
        .btn { background: var(--accent); color: black; font-weight: bold; border: none; padding: 10px 25px; border-radius: 8px; cursor: pointer; }

        /* レイアウト */
        .main-container { display: grid; grid-template-columns: 350px 1fr; gap: 15px; padding: 15px; height: calc(100vh - 85px); }
        
        /* 左サイド：検索結果 */
        #search-results { background: var(--panel); border-radius: 12px; overflow-y: auto; padding: 10px; border: 1px solid #333; }
        .video-card { display: flex; gap: 10px; margin-bottom: 12px; cursor: pointer; padding: 8px; border-radius: 8px; background: #222; border: 1px solid transparent; }
        .video-card:hover { border-color: var(--accent); background: #2a2a2a; }
        .video-card img { width: 100px; border-radius: 6px; pointer-events: none; }
        .video-title { font-size: 12px; font-weight: bold; pointer-events: none; }

        /* 右サイド：表示エリア */
        .display-side { display: flex; flex-direction: column; gap: 15px; overflow: hidden; }
        #player { width: 100%; height: 350px; background: #000; border-radius: 12px; }
        
        /* 歌詞パネル */
        .lyrics-box { flex-grow: 1; background: #000; border-radius: 12px; border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; }
        .lyrics-control { background: #1a1a1a; padding: 10px 20px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #333; }
        .lyrics-control input { width: 250px; padding: 5px 10px; font-size: 14px; }
        #lyrics-content { flex-grow: 1; padding: 40px; overflow-y: auto; font-size: 32px; line-height: 1.8; text-align: center; white-space: pre-wrap; color: #fff; font-weight: bold; }

        /* 起動画面 */
        #boot-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; }
    </style>
</head>
<body>

<div id="boot-screen" onclick="startApp()">
    <button class="btn" style="font-size: 28px; padding: 25px 80px; border-radius: 50px;">SING START</button>
</div>

<div class="header">
    <input type="text" id="search-q" placeholder="歌いたい曲をYouTube検索...">
    <button class="btn" onclick="search()">動画検索</button>
</div>

<div class="main-container">
    <div id="search-results">曲を検索してください</div>

    <div class="display-side">
        <div id="player"></div>
        
        <div class="lyrics-box">
            <div class="lyrics-control">
                <span style="font-size: 12px; color: #888;">歌詞が合わない場合は入力 →</span>
                <input type="text" id="manual-lyrics-q" placeholder="正確な曲名を入力...">
                <button class="btn" style="padding: 5px 15px; font-size: 12px;" onclick="manualFetch()">歌詞再検索</button>
            </div>
            <div id="lyrics-content">動画を選択してください</div>
        </div>
    </div>
</div>

<script>
    const API_KEY = 'AIzaSyB_tQGyb86O2w0_5Y0LpGpRS6OkIxkF_ro';
    let player, audioCtx;

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            videoId: 'LpI2vjX9mDM',
            playerVars: { 'modestbranding': 1, 'origin': window.location.origin }
        });
    }

    // YouTube動画検索
    async function search() {
        const q = document.getElementById('search-q').value;
        if (!q) return;
        const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(q + " カラオケ")}&type=video&maxResults=15&key=${API_KEY}`;
        try {
            const res = await fetch(url);
            const data = await res.json();
            const list = document.getElementById('search-results');
            list.innerHTML = "";
            data.items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'video-card';
                card.onclick = () => selectVideo(item.id.videoId, item.snippet.title);
                card.innerHTML = `<img src="${item.snippet.thumbnails.medium.url}"><div class="video-title">${item.snippet.title}</div>`;
                list.appendChild(card);
            });
        } catch (e) { alert("動画検索エラー"); }
    }

    function selectVideo(id, title) {
        player.loadVideoById(id);
        // タイトルからノイズを削る
        let cleanTitle = title.replace(/【.*?】|\[.*?\]|カラオケ|KARAOKE|off vocal|歌ってみた|歌詞付き|歌詞入り|Music Video|MV|Official|フル|/gi, "")
                              .replace(/-|／|/g, " ").trim();
        document.getElementById('manual-lyrics-q').value = cleanTitle;
        fetchLyrics(cleanTitle);
    }

    function manualFetch() {
        const q = document.getElementById('manual-lyrics-q').value;
        fetchLyrics(q);
    }

    // 歌詞取得エンジン (LRCLIB)
    async function fetchLyrics(q) {
        const content = document.getElementById('lyrics-content');
        content.innerText = "歌詞を検索中...";
        
        try {
            const res = await fetch(`https://lrclib.net/api/search?q=${encodeURIComponent(q)}`);
            const data = await res.json();

            if (data && data.length > 0) {
                // 最もそれらしい候補を表示
                const result = data[0];
                content.innerText = result.plainLyrics || "歌詞データが空でした。";
                content.scrollTop = 0;
            } else {
                content.innerText = "自動検索で見つかりませんでした。\n上の入力欄に「正しい曲名」だけを入力して再検索してください。";
            }
        } catch (e) {
            content.innerText = "通信エラーが発生しました。";
        }
    }

    async function startApp() {
        document.getElementById('boot-screen').style.display = 'none';
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const source = audioCtx.createMediaStreamSource(stream);
            const delay = audioCtx.createDelay();
            delay.delayTime.value = 0.2;
            const feedback = audioCtx.createGain();
            feedback.gain.value = 0.3;
            source.connect(delay); delay.connect(feedback); feedback.connect(delay);
            delay.connect(audioCtx.destination); source.connect(audioCtx.destination);
            player.playVideo();
        } catch (e) { console.log("Mic error"); }
    }
</script>
</body>
</html>