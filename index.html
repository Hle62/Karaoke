<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>AI Karaoke Pro - Synced Lyrics Edition</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        :root { --bg: #050505; --accent: #00f2ff; --panel: #16161a; --text: #e0e0e0; }
        body { font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow: hidden; }
        
        .header { background: var(--panel); padding: 15px; display: flex; justify-content: center; gap: 10px; border-bottom: 2px solid #333; }
        input { width: 350px; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #222; color: white; font-size: 16px; }
        .btn { background: var(--accent); color: black; font-weight: bold; border: none; padding: 10px 25px; border-radius: 8px; cursor: pointer; }

        .main-container { display: grid; grid-template-columns: 350px 1fr; gap: 15px; padding: 15px; height: calc(100vh - 85px); }
        
        #search-results { background: var(--panel); border-radius: 12px; overflow-y: auto; padding: 10px; border: 1px solid #333; }
        .video-card { display: flex; gap: 10px; margin-bottom: 12px; cursor: pointer; padding: 8px; border-radius: 8px; background: #222; border: 1px solid transparent; }
        .video-card:hover { border-color: var(--accent); background: #2a2a2a; }
        .video-card img { width: 100px; border-radius: 6px; pointer-events: none; }
        .video-title { font-size: 12px; font-weight: bold; pointer-events: none; }

        .display-side { display: flex; flex-direction: column; gap: 15px; overflow: hidden; }
        #player { width: 100%; height: 300px; background: #000; border-radius: 12px; }
        
        /* 歌詞表示エリア */
        .lyrics-box { flex-grow: 1; background: #000; border-radius: 12px; border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; }
        .lyrics-control { background: #1a1a1a; padding: 10px 20px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #333; font-size: 12px; }
        
        #lyrics-content { 
            flex-grow: 1; 
            padding: 150px 40px; /* 上下に余白を作って中央寄せを強調 */
            overflow-y: hidden; /* 自動スクロールのため手動は隠す */
            text-align: center; 
            position: relative;
        }

        /* 歌詞の各行のスタイル */
        .lyric-line {
            font-size: 28px;
            font-weight: bold;
            margin: 25px 0;
            opacity: 0.2;
            transition: all 0.4s ease;
            transform: scale(0.9);
        }

        /* アクティブ（現在再生中）な行 */
        .lyric-line.active {
            opacity: 1;
            color: var(--accent);
            transform: scale(1.2);
            text-shadow: 0 0 20px rgba(0, 242, 255, 0.6);
        }

        #boot-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; }
    </style>
</head>
<body>

<div id="boot-screen" onclick="startApp()">
    <button class="btn" style="font-size: 28px; padding: 25px 80px; border-radius: 50px;">KARAOKE ON</button>
</div>

<div class="header">
    <input type="text" id="search-q" placeholder="歌いたい曲を検索...">
    <button class="btn" onclick="search()">動画検索</button>
</div>

<div class="main-container">
    <div id="search-results">曲を選んでください</div>

    <div class="display-side">
        <div id="player"></div>
        <div class="lyrics-box">
            <div class="lyrics-control">
                <span style="color: #888;">歌詞がズレている・出ない場合は入力 →</span>
                <input type="text" id="manual-lyrics-q" placeholder="正確な曲名 アーティスト名" style="width: 200px; padding: 5px;">
                <button class="btn" style="padding: 5px 12px; font-size: 12px;" onclick="manualFetch()">同期歌詞を取得</button>
            </div>
            <div id="lyrics-content"></div>
        </div>
    </div>
</div>

<script>
    const API_KEY = 'AIzaSyB_tQGyb86O2w0_5Y0LpGpRS6OkIxkF_ro';
    let player, audioCtx, syncInterval;
    let syncedLyrics = []; // {time: seconds, text: string}

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            videoId: 'LpI2vjX9mDM',
            playerVars: { 'modestbranding': 1, 'origin': window.location.origin },
            events: {
                'onStateChange': (e) => {
                    if (e.data === YT.PlayerState.PLAYING) startSync();
                    else stopSync();
                }
            }
        });
    }

    async function search() {
        const q = document.getElementById('search-q').value;
        if (!q) return;
        const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(q + " カラオケ")}&type=video&maxResults=15&key=${API_KEY}`;
        try {
            const res = await fetch(url);
            const data = await res.json();
            const list = document.getElementById('search-results');
            list.innerHTML = "";
            data.items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'video-card';
                card.onclick = () => selectVideo(item.id.videoId, item.snippet.title);
                card.innerHTML = `<img src="${item.snippet.thumbnails.medium.url}"><div class="video-title">${item.snippet.title}</div>`;
                list.appendChild(card);
            });
        } catch (e) { console.error(e); }
    }

    function selectVideo(id, title) {
        player.loadVideoById(id);
        let cleanTitle = title.replace(/【.*?】|\[.*?\]|カラオケ|KARAOKE|off vocal|歌ってみた|Music Video|MV|Official|フル|/gi, "").replace(/-|／|/g, " ").trim();
        document.getElementById('manual-lyrics-q').value = cleanTitle;
        fetchLyrics(cleanTitle);
    }

    function manualFetch() { fetchLyrics(document.getElementById('manual-lyrics-q').value); }

    async function fetchLyrics(q) {
        const content = document.getElementById('lyrics-content');
        content.innerHTML = "<div>同期歌詞を読み込み中...</div>";
        syncedLyrics = [];

        try {
            // 同期歌詞優先で検索 (LRCLIB)
            const res = await fetch(`https://lrclib.net/api/search?q=${encodeURIComponent(q)}`);
            const data = await res.json();

            if (data && data.length > 0) {
                const match = data[0];
                const lrc = match.syncedLyrics || match.plainLyrics;
                
                if (match.syncedLyrics) {
                    parseLRC(match.syncedLyrics);
                } else {
                    // 同期データがない場合は通常の歌詞として表示
                    content.innerHTML = `<div class="lyric-line active" style="opacity:1">${match.plainLyrics.replace(/\n/g, "<br>")}</div>`;
                    return;
                }
                renderLyrics();
            } else {
                content.innerHTML = "<div>同期歌詞が見つかりませんでした。<br>上の入力欄で正しい曲名を試してください。</div>";
            }
        } catch (e) { content.innerHTML = "<div>歌詞の取得に失敗しました。</div>"; }
    }

    // LRC形式をパース [mm:ss.xx] text
    function parseLRC(lrc) {
        syncedLyrics = [];
        const lines = lrc.split('\n');
        const timeReg = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/;
        
        lines.forEach(line => {
            const match = timeReg.exec(line);
            if (match) {
                const seconds = parseInt(match[1]) * 60 + parseInt(match[2]) + parseInt(match[3]) / 100;
                const text = line.replace(timeReg, "").trim();
                if (text) syncedLyrics.push({ time: seconds, text: text });
            }
        });
    }

    function renderLyrics() {
        const content = document.getElementById('lyrics-content');
        content.innerHTML = "";
        syncedLyrics.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'lyric-line';
            div.id = 'line-' + index;
            div.innerText = item.text;
            content.appendChild(div);
        });
    }

    function startSync() {
        if (syncInterval) clearInterval(syncInterval);
        syncInterval = setInterval(updateLyrics, 100);
    }

    function stopSync() { clearInterval(syncInterval); }

    function updateLyrics() {
        if (!syncedLyrics.length) return;
        const currentTime = player.getCurrentTime();
        
        // 現在の時間に最適な行を見つける
        let activeIndex = 0;
        for (let i = 0; i < syncedLyrics.length; i++) {
            if (currentTime >= syncedLyrics[i].time) {
                activeIndex = i;
            } else {
                break;
            }
        }

        // 表示の更新
        const lines = document.querySelectorAll('.lyric-line');
        lines.forEach((line, index) => {
            if (index === activeIndex) {
                if (!line.classList.contains('active')) {
                    line.classList.add('active');
                    // スムーズに中央へスクロール
                    line.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            } else {
                line.classList.remove('active');
            }
        });
    }

    async function startApp() {
        document.getElementById('boot-screen').style.display = 'none';
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const source = audioCtx.createMediaStreamSource(stream);
            const delay = audioCtx.createDelay();
            delay.delayTime.value = 0.2;
            const feedback = audioCtx.createGain();
            feedback.gain.value = 0.3;
            source.connect(delay); delay.connect(feedback); feedback.connect(delay);
            delay.connect(audioCtx.destination); source.connect(audioCtx.destination);
            player.playVideo();
        } catch (e) { alert("マイクが起動できませんでした"); }
    }
</script>
</body>
</html>